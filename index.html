<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Läshjälpmedlet Fokus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;700&family=Open+Sans:wght@400;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #1a1a1a;
            --font-size: 1.4rem;
            --line-height: 2.2;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .bionic-bold {
            font-weight: 700;
        }

        /* Läslinjal - Korrigerad styling */
        #reading-ruler {
            position: fixed;
            left: 0;
            width: 100vw;
            height: 50px; /* Definierad höjd */
            background: rgba(250, 204, 21, 0.2); /* Gul transparent färg */
            border-top: 2px solid rgba(250, 204, 21, 0.5);
            border-bottom: 2px solid rgba(250, 204, 21, 0.5);
            z-index: 100;
            pointer-events: none; /* Låter användaren klicka genom linjalen */
            mix-blend-mode: multiply; /* Gör att texten syns bra igenom */
        }

        /* Inställningsmeny */
        .side-panel {
            position: fixed;
            right: -380px;
            top: 0;
            width: 380px;
            height: 100vh;
            background: white;
            border-left: 1px solid #e5e7eb;
            transition: right 0.3s ease-in-out;
            z-index: 200;
            padding: 2rem;
            color: #1f2937;
            box-shadow: -10px 0 30px rgba(0,0,0,0.05);
            overflow-y: auto;
        }

        .side-panel.open {
            right: 0;
        }

        .text-container {
            max-width: 850px;
            margin: 0 auto;
            padding: 6rem 2rem;
            font-size: var(--font-size);
            line-height: var(--line-height);
            min-height: 100vh;
        }

        .clickable-word {
            cursor: help;
            border-bottom: 1px dashed transparent;
            transition: all 0.2s;
        }
        .clickable-word:hover {
            background-color: rgba(37, 99, 235, 0.1);
            border-bottom-color: #2563eb;
        }

        .ai-card {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .mic-active {
            animation: pulse 1.5s infinite;
            background-color: #ef4444 !important;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body class="font-lexend">

    <!-- Menytabb -->
    <div class="fixed top-1/2 -right-1 z-[150] -translate-y-1/2">
        <button onclick="toggleMenu()" class="bg-blue-600 text-white px-3 py-6 rounded-l-2xl shadow-xl font-bold [writing-mode:vertical-rl] hover:bg-blue-700 transition-all">
            Inställningar & AI
        </button>
    </div>

    <div id="settings-panel" class="side-panel">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold">Verktyg</h2>
            <button onclick="toggleMenu()" class="text-gray-400 hover:text-black text-3xl">&times;</button>
        </div>
        
        <div class="space-y-6">
            <!-- Fråga AI Panel -->
            <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                <label class="block text-sm font-semibold text-indigo-800 uppercase mb-2">Fråga texten ✨</label>
                <input id="ai-question" type="text" placeholder="Vad handlar texten om?" class="w-full p-2 mb-2 rounded-xl border border-indigo-200 text-sm">
                <button onclick="askQuestion()" class="w-full py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700">Fråga Gemini</button>
            </div>

            <!-- Översättning -->
            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                <label class="block text-sm font-semibold text-blue-800 uppercase mb-2">Översätt</label>
                <div class="flex gap-2 mb-2">
                    <select id="target-language" class="flex-1 p-2 bg-white border border-blue-200 rounded-xl outline-none text-sm">
                        <option value="svenska">Svenska</option>
                        <option value="engelska">Engelska</option>
                        <option value="spanska">Spanska</option>
                        <option value="arabiska">Arabiska</option>
                    </select>
                    <button onclick="performTranslation(document.getElementById('target-language').value)" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold">Gå</button>
                </div>
                <button onclick="startVoiceCommand()" class="w-full py-2 px-4 bg-white border-2 border-blue-600 text-blue-600 rounded-xl font-bold flex items-center justify-center gap-2 text-xs">
                    Röststyrning
                </button>
            </div>

            <!-- AI Magik -->
            <div class="space-y-2">
                <label class="block text-sm font-semibold text-gray-500 uppercase">Snabbval ✨</label>
                <button onclick="simplifyForChild()" class="w-full py-2 px-4 bg-pink-100 text-pink-700 rounded-xl font-bold text-xs text-left">Förenkla språket</button>
                <button onclick="extractVocabulary()" class="w-full py-2 px-4 bg-emerald-100 text-emerald-700 rounded-xl font-bold text-xs text-left">Bygg ordförråd (svåra ord)</button>
                <button onclick="summarizeText()" class="w-full py-2 px-4 bg-yellow-100 text-yellow-700 rounded-xl font-bold text-xs text-left">Sammanfatta</button>
            </div>

            <!-- Visuella inställningar -->
            <div class="pt-4 border-t border-gray-100 space-y-4">
                <button onclick="toggleRuler()" id="ruler-toggle-btn" class="w-full py-3 bg-gray-800 text-white rounded-xl font-bold text-sm">Visa Läslinjal</button>
                <button onclick="toggleBionic()" class="w-full py-3 bg-purple-600 text-white rounded-xl font-bold text-sm">Bionic Reading</button>
                
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Textstorlek</label>
                    <input type="range" min="16" max="42" value="22" oninput="updateTextStyle('font-size', this.value + 'px')" class="w-full">
                </div>
            </div>
        </div>
    </div>

    <main>
        <!-- Startskärm -->
        <div id="input-section" class="max-w-2xl mx-auto pt-32 px-6 text-center">
            <h1 class="text-5xl font-black mb-4">Fokusläsaren</h1>
            <p class="mb-10 text-xl text-gray-500">Klistra in text eller fota av ett dokument.</p>
            
            <textarea id="text-input" class="w-full h-64 p-6 text-xl border-2 border-gray-100 rounded-3xl shadow-inner focus:border-blue-500 outline-none mb-6 resize-none" placeholder="Skriv eller klistra in här..."></textarea>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="processText()" class="bg-blue-600 text-white px-10 py-5 rounded-2xl font-bold hover:bg-blue-700 shadow-xl">Börja läsa</button>
                <button onclick="triggerCamera()" class="bg-white text-black border-2 border-black px-10 py-5 rounded-2xl font-bold hover:bg-gray-50 flex items-center justify-center gap-2">
                    Fota dokument ✨
                </button>
            </div>

            <input type="file" id="camera-input" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(event)">
        </div>

        <!-- Läsyta -->
        <div id="reader-section" class="hidden">
            <div class="max-w-[850px] mx-auto pt-10 px-4">
                <div id="ai-loading" class="hidden text-center py-4">
                    <div class="loader mr-2"></div> <span class="text-sm font-bold text-gray-500 italic">Gemini tänker...</span>
                </div>
                
                <div id="summary-display" class="hidden ai-card border-blue-200 bg-blue-50 relative animate-in fade-in duration-300">
                    <button onclick="this.parentElement.classList.add('hidden')" class="absolute top-2 right-4 text-gray-400 hover:text-black">&times;</button>
                    <h3 class="font-bold text-blue-900 mb-2" id="summary-title">Resultat</h3>
                    <div id="summary-content" class="text-blue-950 text-base leading-relaxed"></div>
                </div>
            </div>

            <div id="content-display" class="text-container"></div>
            
            <div class="fixed bottom-10 left-10 flex gap-4">
                <button onclick="location.reload()" class="bg-white px-6 py-3 rounded-2xl border-2 border-black font-bold shadow-lg">← Ny text</button>
            </div>
        </div>
    </main>

    <!-- Linjal-elementet som nu har styling -->
    <div id="reading-ruler" class="hidden"></div>

    <script>
        const apiKey = ""; 
        let originalText = "";
        let currentDisplayedText = "";
        let isBionic = false;
        let isRulerActive = false;

        function toggleMenu() { document.getElementById('settings-panel').classList.toggle('open'); }
        
        function cleanMarkdown(text) {
            if (!text) return "";
            return text.replace(/[#*`_~]/g, '').trim();
        }

        function updateTextStyle(prop, val) {
            document.documentElement.style.setProperty(`--${prop}`, val);
        }

        function toggleRuler() {
            isRulerActive = !isRulerActive;
            const ruler = document.getElementById('reading-ruler');
            ruler.classList.toggle('hidden', !isRulerActive);
            document.getElementById('ruler-toggle-btn').textContent = isRulerActive ? "Dölj Läslinjal" : "Visa Läslinjal";
        }

        // Uppdaterar linjalens position vid musrörelse
        window.addEventListener('mousemove', (e) => {
            if (isRulerActive) {
                const ruler = document.getElementById('reading-ruler');
                // Centrerar linjalen vertikalt runt muspekaren
                ruler.style.top = (e.clientY - 25) + 'px';
            }
        });

        async function callGemini(prompt, base64Image = null) {
            document.getElementById('ai-loading').classList.remove('hidden');
            let retries = 0;
            const backoff = [1000, 2000, 4000, 8000, 16000];

            while (retries < 5) {
                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    };

                    if (base64Image) {
                        payload.contents[0].parts.push({
                            inlineData: { mimeType: "image/png", data: base64Image }
                        });
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error("API Request Failed");
                    const data = await response.json();
                    document.getElementById('ai-loading').classList.add('hidden');
                    return cleanMarkdown(data.candidates[0].content.parts[0].text);
                } catch (err) {
                    await new Promise(r => setTimeout(r, backoff[retries]));
                    retries++;
                }
            }
            document.getElementById('ai-loading').classList.add('hidden');
            return "Kunde inte nå AI:n. Kontrollera anslutningen.";
        }

        function triggerCamera() { document.getElementById('camera-input').click(); }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result.split(',')[1];
                const text = await callGemini("Läs av texten i denna bild och returnera den exakta texten på svenska.", base64Data);
                if (text) {
                    document.getElementById('text-input').value = text;
                    processText();
                }
            };
            reader.readAsDataURL(file);
        }

        async function askQuestion() {
            const q = document.getElementById('ai-question').value;
            if (!q) return;
            const res = await callGemini(`Baserat på denna text: "${currentDisplayedText}", svara på frågan: ${q}. Svara kort och koncist på svenska.`);
            showResult("Svar på din fråga", res);
        }

        async function extractVocabulary() {
            const res = await callGemini(`Hitta 5 potentiellt svåra ord i följande text och förklara dem enkelt på svenska: ${currentDisplayedText}`);
            showResult("Ordförklaringar", res.replace(/\n/g, '<br>'));
        }

        async function explainWord(word) {
            const res = await callGemini(`Vad betyder ordet "${word}" kortfattat på svenska?`);
            showResult(`Betydelse: ${word}`, res);
        }

        async function simplifyForChild() {
            const res = await callGemini(`Skriv om denna text så att ett barn förstår: ${currentDisplayedText}`);
            currentDisplayedText = res;
            renderText();
        }

        async function summarizeText() {
            const res = await callGemini(`Sammanfatta denna text kort: ${currentDisplayedText}`);
            showResult("Sammanfattning", res.replace(/\n/g, '<br>'));
        }

        function processText() {
            originalText = document.getElementById('text-input').value;
            if (!originalText.trim()) return;
            currentDisplayedText = originalText;
            document.getElementById('input-section').classList.add('hidden');
            document.getElementById('reader-section').classList.remove('hidden');
            renderText();
        }

        function renderText() {
            const container = document.getElementById('content-display');
            const paragraphs = currentDisplayedText.split('\n');
            container.innerHTML = paragraphs.map(p => {
                if (!p.trim()) return '<div class="h-6"></div>';
                const words = p.split(' ').map(word => {
                    const clean = word.replace(/[.,!?;:()]/g, '');
                    const bionic = isBionic ? makeBionic(word) : word;
                    return `<span class="clickable-word" onclick="explainWord('${clean}')">${bionic}</span>`;
                }).join(' ');
                return `<p class="mb-4">${words}</p>`;
            }).join('');
        }

        function makeBionic(word) {
            if (word.length < 2) return word;
            const boldLen = Math.ceil(word.length * 0.4);
            return `<span class="bionic-bold">${word.substring(0, boldLen)}</span>${word.substring(boldLen)}`;
        }

        function toggleBionic() {
            isBionic = !isBionic;
            renderText();
        }

        function showResult(title, content) {
            document.getElementById('summary-title').textContent = title;
            document.getElementById('summary-content').innerHTML = content;
            document.getElementById('summary-display').classList.remove('hidden');
            document.getElementById('summary-display').scrollIntoView({ behavior: 'smooth' });
        }

        function startVoiceCommand() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'sv-SE';
            recognition.onstart = () => { showResult("Röststyrning", "Lyssnar..."); };
            recognition.onresult = async (event) => {
                const cmd = event.results[0][0].transcript;
                const action = await callGemini(`Användaren sa: "${cmd}". Vill de SAMMANFATTA, FÖRENKLA eller ÖVERSÄTT? Svara bara med ett ord.`);
                if (action.includes("SAMMANFATTA")) summarizeText();
                else if (action.includes("FÖRENKLA")) simplifyForChild();
            };
            recognition.start();
        }

        async function performTranslation(lang) {
            const res = await callGemini(`Översätt till ${lang}: ${originalText}`);
            currentDisplayedText = res;
            renderText();
        }
    </script>
</body>
</html>